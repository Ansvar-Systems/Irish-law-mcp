name: Daily Data Freshness Check

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      limit_pages:
        description: 'Optional max page count for API scan (0 = all pages)'
        required: false
        default: '0'

permissions:
  contents: read
  issues: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      updates_found: ${{ steps.check.outputs.updates_found }}
      summary: ${{ steps.check.outputs.summary }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build TypeScript
        run: npm run build

      - name: Run freshness check
        id: check
        env:
          LIMIT_PAGES: ${{ github.event.inputs.limit_pages || '0' }}
        run: |
          set +e

          LIMIT_ARG=""
          if [ "$LIMIT_PAGES" != "0" ]; then
            LIMIT_ARG="--limit-pages $LIMIT_PAGES"
          fi

          npx tsx scripts/check-updates.ts $LIMIT_ARG 2>&1 | tee check_output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          if [ "$EXIT_CODE" -eq 1 ]; then
            echo "updates_found=true" >> "$GITHUB_OUTPUT"
            echo "summary<<EOF" >> "$GITHUB_OUTPUT"
            tail -n 40 check_output.txt >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "updates_found=false" >> "$GITHUB_OUTPUT"
            echo "summary=No updates detected" >> "$GITHUB_OUTPUT"
          fi

          # Keep workflow green even when updates are found.
          exit 0

      - name: Upload check output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: check-updates-output
          path: check_output.txt
          retention-days: 14

  report:
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.updates_found == 'true'
    steps:
      - name: Create issue
        uses: actions/github-script@v8
        env:
          SUMMARY: ${{ needs.check-updates.outputs.summary }}
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `Ireland law data updates detected - ${today}`;
            const body = [
              'Automated freshness check detected upstream updates.',
              '',
              '```text',
              process.env.SUMMARY || 'No summary available',
              '```',
              '',
              'Next steps:',
              '1. Run `npm run ingest`',
              '2. Run `npm run build:db`',
              '3. Run `npm run test:contract`',
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['data-freshness', 'automated'],
            });
